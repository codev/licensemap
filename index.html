<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Map - A London Renters Union project v1.14</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 600;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #controls #title {
            -display: inline-block;
            font-size: 13px;
            margin-bottom: 5px;
        }
        #controls #title a {
            color: #e63946;
            text-decoration: none;
            font-weight: bold;
        }
        #controls #title a:hover {
            text-decoration: underline;
        }
        #controls select, #controls input[type="text"] {
            margin: 2px;
            padding: 3px 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 13px;
        }
        #notesPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 601;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }
        #notesPanel h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #notesPanel .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #notesPanel .close-btn:hover {
            color: #e63946;
        }
        #notesPanel .note-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            border-left: 3px solid #e63946;
        }
        #notesPanel .note-author {
            font-weight: bold;
            color: #e63946;
            font-size: 12px;
        }
        #notesPanel .note-text {
            margin: 5px 0;
            font-size: 13px;
        }
        #notesPanel .note-time {
            font-size: 11px;
            color: #666;
        }
        #notesPanel .note-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }
        #notesPanel .note-form input,
        #notesPanel .note-form textarea {
            width: 100%;
            margin-bottom: 8px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }
        #notesPanel .note-form textarea {
            min-height: 60px;
            resize: vertical;
        }
        #notesPanel .note-form button {
            background: #e63946;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        #notesPanel .note-form button:hover {
            background: #d62839;
        }
        #notesPanel .note-form button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #notesPanel .no-property {
            color: #666;
            font-style: italic;
            font-size: 13px;
        }
        #notesPanel .error-message {
            color: #e63946;
            font-size: 12px;
            margin-top: 5px;
        }
        #notesPanel .success-message {
            color: #4caf50;
            font-size: 12px;
            margin-top: 5px;
        }
        #controls .ss-main {
            font-size: 13px;
            background-color: #eee;
            color: black;
            margin: 2px;
            min-width: auto;
        }
        #controls input[type="text"] {
            width: 150px;
        }
        #resultCount {
            margin-left: 5px;
            font-size: 12px;
            color: #666;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .hidden {
            display: none !important;
        }
        .view-notes-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: #e63946;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }
        .view-notes-btn:hover {
            background: #d62839;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e63946;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingOverlay p {
            margin-top: 20px;
            font-size: 16px;
            color: #333;
        }

    </style>
</head>
<body>
    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
        <p>Loading property data...</p>
    </div>

    <div id="controls">
        <div id="title"><a href="https://github.com/codev/licensemap">License Map</a> - An <a href="https://londonrentersunion.org" target="_blank">LRU</a> project</div>
        <select id="boroughSelector">
            <option value="brent">Brent</option>
            <option value="hackney" selected="selected">Hackney</option>
            <option value="haringey">Haringey</option>
            <option value="islington">Islington</option>
            <option value="lambeth">Lambeth</option>
            <option value="lewisham">Lewisham</option>
            <option value="newham">Newham</option>
            <option value="towerhamlets">Tower Hamlets</option>
            <option value="walthamforest">Waltham Forest</option>
        </select>
        <select id="landlordFilter">
            <option value="">&lt;All landlords...&gt;</option>
        </select>
        <select id="agentFilter">
            <option value="">&lt;All agents...&gt;</option>
        </select>
        <select id="noteFilter">
            <option value="">All properties</option>
            <option value="with">With notes</option>
            <option value="without">Without notes</option>
        </select>
        <input type="text" id="postcodeFilter" placeholder="Postcode">
        <span id="resultCount"></span>
    </div>
    <div id="map"></div>

    <div id="notesPanel" class="hidden">
        <h3>
            <span>Property Notes</span>
            <button class="close-btn" id="closeNotesBtn" title="Close notes panel">&times;</button>
        </h3>
        <div id="notesPanelContent">
            <p class="no-property">Click on a property marker to view and add notes.</p>
        </div>
        <div class="note-form">
            <h4 style="margin: 0 0 8px 0; font-size: 14px;">Add a Note</h4>
            <input type="text" id="noteAuthorInput" placeholder="Your name" />
            <textarea id="noteTextInput" placeholder="Enter your note on doorknocking/licensing etc..."></textarea>
            <button id="submitNoteBtn" disabled>Submit Note</button>
            <div id="noteFormMessage"></div>
        </div>
    </div>

    <script>
        // Debounce utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // init map
        const map = L.map('map').setView([0, 0], 2);
        
        // Add OSM tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let allData = [];
        let allMarkers = [];
        let markerClusterGroup = L.markerClusterGroup();

        // Notes feature variables
        // IMPORTANT: Replace this URL with your deployed Google Apps Script web app URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqePCb9IMNEZvovJjixCX6BIBP7GchaVNhdnNu4NOwyBTpO9xuT-baPtwswPP8CVxr/exec';
        let notesData = {}; // Will store notes indexed by address
        let selectedProperty = null; // Currently selected property for note submission

        // Borough licensing register URLs
        const LICENSING_URLS = {
            "Hackney": "https://www.hackney.gov.uk/property-licensing",
            "Haringey": "https://www.haringey.gov.uk/housing/property-licensing",
            "Barking and Dagenham": "https://www.lbbd.gov.uk/private-sector-housing/licensing",
            "Croydon": "https://www.croydon.gov.uk/housing/landlords",
            "Ealing": "https://www.ealing.gov.uk/info/201086/housing_and_council_tax/3306/private_rented_property_licensing",
            "Enfield": "https://www.enfield.gov.uk/services/housing/private-rented-property-licensing",
            "Greenwich": "http://www.royalgreenwich.gov.uk/info/200069/multiple_occupancy_homes/937/hmo_licensing",
            "Havering": "https://www.havering.gov.uk/info/20060/information_for_landlords/336/guidance_on_letting_your_property_to_multiple_residents",
            "Islington": "https://www.islington.gov.uk/housing/private-sector-housing/landlords/houses-in-multiple-occupation-hmos",
            "Kensington and Chelsea": "http://www.rbkc.gov.uk/housing/livinginhealthyhomes/housesinmultipleoccupation.aspx",
            "Lambeth": "https://www.lambeth.gov.uk/housing/landlords-licensing",
            "Lewisham": "https://lewisham.gov.uk/myservices/housing/private-tenants-and-landlords/landlords",
            "Southwark": "https://www.southwark.gov.uk/housing/private-tenants-and-landlords/private-rented-property-licensing",
            "Waltham Forest": "https://www.walthamforest.gov.uk/service-categories/private-landlords",
            "Westminster": "https://www.westminster.gov.uk/housing/private-sector-housing",
            "Newham": "http://www.newham.gov.uk/Pages/Services/Private-rented-property-licensing.aspx",
            "Tower Hamlets": "https://www.towerhamlets.gov.uk/lgnl/housing/Private-tenants-landlords-and-homeowners/Private-Landlords/Landlord_Licensing_Schemes.aspx",
            "Brent": "https://www.brent.gov.uk/housing/landlords/property-licensing#findoutifyouneedalicence",
            "Redbridge": "https://www.redbridge.gov.uk/housing/private-rentals/",
        };
      const LICENSING_EMAILS = {
            "Hackney": "property.licensing@hackney.gov.uk",
            "Haringey": "propertylicensing@haringey.gov.uk",
            "Barking and Dagenham": "PRPL@lbbd.gov.uk",
            "Croydon": "hmo@croydon.gov.uk",
            "Ealing": "prslicensing@ealing.gov.uk",
            "Enfield": "prsh@enfield.gov.uk",
            "Greenwich": "private-rented-property-licensing@royalgreenwich.gov.uk",
            "Havering": "landlordlicensing@havering.gov.uk",
            "Islington": "property.licensing@islington.gov.uk",
            "Kensington and Chelsea": "hmolicensing@rbkc.gov.uk",
            "Lambeth": "prslicensing@lambeth.gov.uk",
            "Lewisham": "pshe@lewisham.gov.uk",
            "Southwark": "resi@southwark.gov.uk",
            "Waltham Forest": "propertylicensing@walthamforest.gov.uk",
            "Westminster": "HMO@westminster.gov.uk ",
            "Newham": "propertylicensing@newham.gov.uk",
            "Tower Hamlets": "housinglicensing@towerhamlets.gov.uk",
            "Brent": "prslicensing@brent.gov.uk",
            "Redbridge": "prslicensing@redbridge.gov.uk",
        };
      const OTHER_LICENSE_DETAILS = {
            "Hackney": "",
            "Haringey": "",
            "Barking and Dagenham": "",
            "Croydon": "",
            "Ealing": "",
            "Enfield": "",
            "Greenwich": "",
            "Havering": "",
            "Islington": "",
            "Kensington and Chelsea": "",
            "Lambeth": "",
            "Lewisham": "",
            "Southwark": "",
            "Waltham Forest": "",
            "Westminster": "",
            "Newham": "",
            "Tower Hamlets": "",
            "Brent": "",
            "Redbridge": "",
        };
      const REGISTER_URLS = {
            "Hackney": "https://propertylicensing.hackney.gov.uk/public-register",
            "Haringey": "https://propertylicensing.haringey.gov.uk/public-register",
            "Barking and Dagenham": "https://lbbd.metastreet.co.uk/public-register",
            "Croydon": "https://landlordlicensing.croydon.gov.uk/public-register",
            "Ealing": "https://ealing.metastreet.co.uk/public-register",
            "Enfield": "https://enfield.metastreet.co.uk/public-register",
            "Greenwich": "https://greenwich.metastreet.co.uk/public-register",
            "Havering": "https://housingpropertylicence.havering.gov.uk/public-register",
            "Islington": "https://propertylicensing.islington.gov.uk/public-register",
            "Kensington and Chelsea": "https://rbkc.metastreet.co.uk/public-register",
            "Lambeth": "https://hmolicensing.lambeth.gov.uk/public-register",
            "Lewisham": "https://lewisham.metastreet.co.uk/public-register",
            "Southwark": "https://southwark.metastreet.co.uk/public-register",
            "Waltham Forest": "https://propertylicensing.walthamforest.gov.uk/public-register",
            "Westminster": "https://westminster.metastreet.co.uk/public-register",
            "Newham": "https://www.newham.gov.uk/landlords-newham/rented-property-licensing/6",
            "Tower Hamlets": "https://www.towerhamlets.gov.uk/lgnl/housing/Private-tenants-landlords-and-homeowners/Private-Landlords/Private-landlords.aspx",
            "Brent": "https://www.brent.gov.uk/-/media/files/resident-documents/housing-documents/online-register-of-licenced-properties.pdf?",
            "Redbridge": "https://propertylicensing.redbridge.gov.uk/online-application/public-register/",
        };
        
        // Add jitter to coordinates
        function addJitter(value) {
            return value;
            // 2025-11-06 disable jitter
            //return value + (Math.random() - 0.5) * 0.0009;
        }
        
        // Load notes from Google Sheets
        // refreshMarkers: if true, will rebuild all markers (only on initial load)
        async function loadNotes(refreshMarkers = false) {
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                console.warn('Google Apps Script URL not configured. Notes feature will not work.');
                return;
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();

                if (data.success && data.notes) {
                    // Index notes by address for quick lookup
                    notesData = {};
                    data.notes.forEach(note => {
                        const address = note.address;
                        if (!notesData[address]) {
                            notesData[address] = [];
                        }
                        notesData[address].push(note);
                    });

                    console.log(`Loaded ${data.notes.length} notes for ${Object.keys(notesData).length} properties`);

                    // Only update markers on initial load, not during auto-refresh
                    if (refreshMarkers) {
                        updateMarkers();
                    } else {
                        // On auto-refresh, only update the notes panel if it's currently open
                        if (!document.getElementById('notesPanel').classList.contains('hidden') && selectedProperty) {
                            updateNotesPanel();
                        }
                    }
                } else {
                    console.error('Error loading notes:', data.error);
                }
            } catch (error) {
                console.error('Error fetching notes:', error);
            }
        }

        // Get notes for a specific address
        function getNotesForAddress(address) {
            return notesData[address] || [];
        }

        // Open notes panel for a specific property (called from popup button)
        function openNotesForProperty(address) {
            // Find the property data by address
            const property = allData.find(row => (row.Address || row.address) === address);
            if (property) {
                selectedProperty = property;
                document.getElementById('notesPanel').classList.remove('hidden');
                updateNotesPanel();
            }
        }

        // Update the notes panel display
        function updateNotesPanel() {
            const contentDiv = document.getElementById('notesPanelContent');
            const submitBtn = document.getElementById('submitNoteBtn');

            if (!selectedProperty) {
                contentDiv.innerHTML = '<p class="no-property">Click on a property marker to view and add notes.</p>';
                submitBtn.disabled = true;
                return;
            }

            const address = selectedProperty.Address || selectedProperty.address;
            const notes = getNotesForAddress(address);

            if (notes.length === 0) {
                contentDiv.innerHTML = `<p class="no-property">No notes yet for this property.</p>`;
            } else {
                let html = '';
                notes.forEach(note => {
                    const timestamp = new Date(note.timestamp).toLocaleString();
                    html += `
                        <div class="note-item">
                            <div class="note-author">${note.name}</div>
                            <div class="note-text">${note.note}</div>
                            <div class="note-time">${timestamp}</div>
                        </div>
                    `;
                });
                contentDiv.innerHTML = html;
            }

            submitBtn.disabled = false;
        }

        // Filter and display markers
        function updateMarkers() {
            const landlordFilter = document.getElementById('landlordFilter').value;
            const agentFilter = document.getElementById('agentFilter').value;
            const postcodeFilter = document.getElementById('postcodeFilter').value.replace(/\s/g, '').toUpperCase();
            const noteFilter = document.getElementById('noteFilter').value;

            // Clear existing markers from cluster group
            markerClusterGroup.clearLayers();
            allMarkers = [];

            // Filter and add markers (using pre-normalized postcodes)
            const filteredData = allData.filter(row => {
                const matchesLandlord = !landlordFilter || row.Landlord === landlordFilter;
                const matchesAgent = !agentFilter || row.Agent === agentFilter;
                const matchesPostcode = !postcodeFilter || (row._normalizedPostcode && row._normalizedPostcode.startsWith(postcodeFilter));

                // Note filter
                let matchesNotes = true;
                if (noteFilter) {
                    const address = row.Address || row.address;
                    const hasNotes = address && notesData[address] && notesData[address].length > 0;
                    if (noteFilter === 'with') {
                        matchesNotes = hasNotes;
                    } else if (noteFilter === 'without') {
                        matchesNotes = !hasNotes;
                    }
                }

                return matchesLandlord && matchesAgent && matchesPostcode && matchesNotes;
            });

            filteredData.forEach(row => {
                const lat = addJitter(row.latitude || row.Latitude || row.lat);
                const lng = addJitter(row.longitude || row.Longitude || row.lng || row.lon);

                if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const address = row.Address || row.address;
                    const notes = getNotesForAddress(address);
                    const noteCount = notes.length;

                    let borough = null;
                    let popupContent = '<div style="max-width: 250px;">';
                    Object.keys(row).forEach(key => {
                        if (key.toLowerCase() == 'borough') {
                          borough = row[key];
                        } else if (key.toLowerCase() !== 'latitude' && key.toLowerCase() !== 'longitude' && !key.startsWith('_') && row[key]) {
                            popupContent += `<strong>${key}:</strong> ${row[key]}<br>`;
                        }
                    });

                    // Add licensing register link
                    if (borough) {
                        popupContent += `<br><strong>${borough}</strong>`;
                        if (LICENSING_URLS[borough]) {
                          popupContent += ` - <a href="${LICENSING_URLS[borough]}" target="_blank" style="color: #e63946; text-decoration: none;">Council website</a>`;
                        }
                        if (REGISTER_URLS[borough]) {
                          popupContent += ` - <a href="${REGISTER_URLS[borough]}" target="_blank" style="color: #e63946; text-decoration: none;">Public register</a>`;
                        }
                        if (LICENSING_EMAILS[borough]) {
                          popupContent += ` - <span>Email:</span> <span style="overflow-wrap: break-word; word-wrap: break-word;">${LICENSING_EMAILS[borough]}</span>`;
                        }
                        popupContent += '<br>';
                    }

                    // Add notes count to popup
                    if (noteCount > 0) {
                        popupContent += `<br><strong style="color: #e63946;">${noteCount} note${noteCount !== 1 ? 's' : ''}</strong>`;
                    }

                    // Add "View Notes" button
                    popupContent += `<br><button class="view-notes-btn" onclick="openNotesForProperty('${address.replace(/'/g, "\\'")}')">View Notes</button>`;

                    popupContent += '</div>';

                    const marker = L.marker([lat, lng]);
                    marker.bindPopup(popupContent);

                    // Store property data on marker for click handler
                    marker.propertyData = row;

                    // Add click handler to show notes panel on wider screens
                    marker.on('click', function() {
                        selectedProperty = this.propertyData;
                        // Only auto-open notes panel on desktop
                        if (window.innerWidth >= 950) {
                            document.getElementById('notesPanel').classList.remove('hidden');
                            updateNotesPanel();
                        }
                    });

                    markerClusterGroup.addLayer(marker);
                    allMarkers.push(marker);
                }
            });

            // Add cluster group to map
            map.addLayer(markerClusterGroup);

            // Fit map to show all markers
            if (allMarkers.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }

            // Update result count
            const resultCountElement = document.getElementById('resultCount');
            if (landlordFilter || agentFilter || postcodeFilter || noteFilter) {
                resultCountElement.textContent = `${filteredData.length} result${filteredData.length !== 1 ? 's' : ''}`;
            } else {
                resultCountElement.textContent = '';
            }
        }

        // Variables for slim-select instances
        let landlordSlimSelect = null;
        let agentSlimSelect = null;

        // Show/hide loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Load CSV for a specific borough
        function loadBorough(borough) {
            showLoading();

            // Clear existing data
            allData = [];
            markerClusterGroup.clearLayers();
            allMarkers = [];
            document.getElementById('postcodeFilter').value = '';

            const csvUrl = `https://raw.githubusercontent.com/codev/licensemap/main/${borough}.csv`;

            Papa.parse(csvUrl, {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: results => {
                    allData = results.data;

                    // Pre-normalize postcodes for faster filtering
                    allData.forEach(row => {
                        if (row.Postcode) {
                            row._normalizedPostcode = row.Postcode.replace(/\s/g, '').toUpperCase();
                        }
                    });

                    console.log(`Loaded ${allData.length} properties from ${borough}.csv`);

                    // Count occurrences and populate dropdowns
                    const landlordCounts = {};
                    const agentCounts = {};

                    allData.forEach(row => {
                        if (row.Landlord) {
                            landlordCounts[row.Landlord] = (landlordCounts[row.Landlord] || 0) + 1;
                        }
                        if (row.Agent) {
                            agentCounts[row.Agent] = (agentCounts[row.Agent] || 0) + 1;
                        }
                    });

                    const landlordSelect = document.getElementById('landlordFilter');
                    const agentSelect = document.getElementById('agentFilter');

                    // Clear existing options (except first one)
                    landlordSelect.innerHTML = '<option value="">&lt;All landlords...&gt;</option>';
                    agentSelect.innerHTML = '<option value="">&lt;All agents...&gt;</option>';

                    // Sort by count (highest first) and populate
                    Object.entries(landlordCounts)
                        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
                        .forEach(([landlord, count]) => {
                            const option = document.createElement('option');
                            option.value = landlord;
                            const displayName = landlord.length > 30 ? landlord.substring(0, 30) + '...' : landlord;
                            option.textContent = `${displayName} (${count})`;
                            option.title = landlord;
                            landlordSelect.appendChild(option);
                        });

                    Object.entries(agentCounts)
                        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
                        .forEach(([agent, count]) => {
                            const option = document.createElement('option');
                            option.value = agent;
                            const displayName = agent.length > 30 ? agent.substring(0, 30) + '...' : agent;
                            option.textContent = `${displayName} (${count})`;
                            option.title = agent;
                            agentSelect.appendChild(option);
                        });

                    // Destroy existing slim-select instances if they exist
                    if (landlordSlimSelect) {
                        landlordSlimSelect.destroy();
                    }
                    if (agentSlimSelect) {
                        agentSlimSelect.destroy();
                    }

                    // Initialize slim-select for landlord dropdown
                    landlordSlimSelect = new SlimSelect({
                        select: '#landlordFilter',
                        settings: {
                            showSearch: true,
                            searchPlaceholder: 'Search landlords...',
                            searchHighlight: true,
                            closeOnSelect: true
                        },
                        events: {
                            afterChange: () => {
                                agentSlimSelect.setSelected('');
                                document.getElementById('postcodeFilter').value = '';
                                updateMarkers();
                            }
                        }
                    });

                    // Initialize slim-select for agent dropdown
                    agentSlimSelect = new SlimSelect({
                        select: '#agentFilter',
                        settings: {
                            showSearch: true,
                            searchPlaceholder: 'Search agents...',
                            searchHighlight: true,
                            closeOnSelect: true
                        },
                        events: {
                            afterChange: () => {
                                landlordSlimSelect.setSelected('');
                                document.getElementById('postcodeFilter').value = '';
                                updateMarkers();
                            }
                        }
                    });

                    // Initial display
                    updateMarkers();
                    loadNotes(true); // Pass true to refresh markers on initial load
                    hideLoading();
                },
                error: error => {
                    console.error('Error loading CSV:', error);
                    alert(`Failed to load ${borough} data. Please try again.`);
                    hideLoading();
                }
            });
        }

        // Add event listener for note filter (one time setup)
        document.getElementById('noteFilter').addEventListener('change', () => {
            updateMarkers();
        });

        // Add debounced event listener for postcode input (one time setup)
        const postcodeInput = document.getElementById('postcodeFilter');
        const debouncedUpdate = debounce(() => {
            if (landlordSlimSelect) landlordSlimSelect.setSelected('');
            if (agentSlimSelect) agentSlimSelect.setSelected('');
            updateMarkers();
        }, 300);
        postcodeInput.addEventListener('input', debouncedUpdate);

        // Add event listener for borough selector
        document.getElementById('boroughSelector').addEventListener('change', function() {
            const selectedBorough = this.value;
            loadBorough(selectedBorough);
        });

        // Load default borough (Hackney) on page load
        loadBorough('hackney');

        // Auto-refresh notes every 2 minutes when page is visible
        function setupNotesAutoRefresh() {
            setInterval(() => {
                // Only refresh if page is visible
                if (!document.hidden) {
                    loadNotes();
                }
            }, 120000); // 2 minutes (120 seconds)
        }

        // Start auto-refresh after initial load
        setupNotesAutoRefresh();

        // Close button functionality
        document.getElementById('closeNotesBtn').addEventListener('click', function() {
            document.getElementById('notesPanel').classList.add('hidden');
            selectedProperty = null;
        });

        // Close notes panel on mobile by default
        if (window.innerWidth < 950) {
            document.getElementById('notesPanel').classList.add('hidden');
        }

        // Note submission functionality
        document.getElementById('submitNoteBtn').addEventListener('click', async function() {
            const authorInput = document.getElementById('noteAuthorInput');
            const textInput = document.getElementById('noteTextInput');
            const messageDiv = document.getElementById('noteFormMessage');

            const author = authorInput.value.trim();
            const noteText = textInput.value.trim();

            // Clear previous messages
            messageDiv.innerHTML = '';

            // Validate inputs
            if (!author || !noteText) {
                messageDiv.innerHTML = '<div class="error-message">Please enter both your name and a note.</div>';
                return;
            }

            if (!selectedProperty) {
                messageDiv.innerHTML = '<div class="error-message">No property selected.</div>';
                return;
            }

            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                messageDiv.innerHTML = '<div class="error-message">Google Apps Script URL not configured.</div>';
                return;
            }

            const address = selectedProperty.Address || selectedProperty.address;

            // Disable button during submission
            this.disabled = true;
            this.textContent = 'Submitting...';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        name: author,
                        note: noteText
                    })
                });

                // Note: With no-cors mode, we can't read the response
                // But we can assume success and reload notes
                messageDiv.innerHTML = '<div class="success-message">Note submitted successfully!</div>';

                // Clear form
                authorInput.value = '';
                textInput.value = '';

                // Reload notes after a short delay to allow Google Sheets to update
                setTimeout(() => {
                    loadNotes();
                    messageDiv.innerHTML = '';
                }, 1500);

            } catch (error) {
                console.error('Error submitting note:', error);
                messageDiv.innerHTML = '<div class="error-message">Error submitting note. Please try again.</div>';
            } finally {
                this.disabled = false;
                this.textContent = 'Submit Note';
            }
        });
    </script>
</body>
</html>
