<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Map - A London Renters Union project v1.15</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 600;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #controls #title {
            -display: inline-block;
            font-size: 13px;
            margin-bottom: 5px;
        }
        #controls #title a {
            color: #e63946;
            text-decoration: none;
            font-weight: bold;
        }
        #controls #title a:hover {
            text-decoration: underline;
        }
        #controls select, #controls input[type="text"] {
            margin: 2px;
            padding: 3px 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 13px;
        }
        #controls button {
            margin: 2px;
            padding: 3px 10px;
            border-radius: 4px;
            border: 2px solid #e63946;
            font-size: 13px;
            background: #fff;
            color: #111;
            cursor: pointer;
            transition: all 0.2s;
        }
        #controls button:hover {
            background: #e63946;
            color: white;
        }
        #notesPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 601;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }
        #notesPanel h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #notesPanel .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #notesPanel .close-btn:hover {
            color: #e63946;
        }
        #notesPanel .note-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            border-left: 3px solid #e63946;
        }
        #notesPanel .note-author {
            font-weight: bold;
            color: #e63946;
            font-size: 12px;
        }
        #notesPanel .note-text {
            margin: 5px 0;
            font-size: 13px;
        }
        #notesPanel .note-time {
            font-size: 11px;
            color: #666;
        }
        #notesPanel .note-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }
        #notesPanel .note-form input,
        #notesPanel .note-form textarea {
            width: 100%;
            margin-bottom: 8px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }
        #notesPanel .note-form textarea {
            min-height: 60px;
            resize: vertical;
        }
        #notesPanel .note-form button {
            background: #e63946;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        #notesPanel .note-form button:hover {
            background: #d62839;
        }
        #notesPanel .note-form button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #notesPanel .no-property {
            color: #666;
            font-style: italic;
            font-size: 13px;
        }
        #notesPanel .error-message {
            color: #e63946;
            font-size: 12px;
            margin-top: 5px;
        }
        #notesPanel .success-message {
            color: #4caf50;
            font-size: 12px;
            margin-top: 5px;
        }
        #controls .ss-main {
            font-size: 13px;
            background-color: #eee;
            color: black;
            margin: 2px;
            min-width: auto;
        }
        #controls input[type="text"] {
            width: 150px;
        }
        #resultCount {
            margin-left: 5px;
            font-size: 12px;
            color: #666;
        }
        #mapLicensingInfo {
            margin-top: 8px;
            font-size: 13px;
            line-height: 1.5;
            max-width: 300px;
        }
        #mapLicensingInfo a {
            color: #e63946;
            text-decoration: none;
        }
        #mapLicensingInfo a:hover {
            text-decoration: underline;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .hidden {
            display: none !important;
        }
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }
        .modal-close-btn:hover {
            color: #e63946;
        }
        .modal-body {
            padding: 20px;
        }
        .view-notes-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: #e63946;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }
        .view-notes-btn:hover {
            background: #d62839;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e63946;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingOverlay p {
            margin-top: 20px;
            font-size: 16px;
            color: #333;
        }

        /* List View Styles */
        #listViewContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: white;
            z-index: 500;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        #listViewHeader {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e63946;
        }
        #listViewLicensingInfo {
            margin-top: 7px;
            display: inline-block;
            line-height: 1.4;
        }
        #listViewLicensingInfo a:hover {
            text-decoration: underline;
        }
        #tableContainer {
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }
        #propertyTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
        }
        #propertyTable thead {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        #propertyTable th {
            background: #e63946;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #d62839;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        #propertyTable th:hover {
            background: #d62839;
        }
        #propertyTable th.sortable::after {
            content: ' ⇅';
            opacity: 0.5;
        }
        #propertyTable th.sort-asc::after {
            content: ' ▲';
            opacity: 1;
        }
        #propertyTable th.sort-desc::after {
            content: ' ▼';
            opacity: 1;
        }
        #propertyTable td {
            padding: 8px;
            border: 1px solid #ddd;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: top;
        }
        #propertyTable tbody tr {
            transition: background-color 0.2s;
        }
        #propertyTable tbody tr:nth-child(even) {
            background: #f9f9f9;
        }
        #propertyTable tbody tr:hover {
            background: #f0f0f0;
        }
        #propertyTable tbody tr.selected {
            background: #ffe5e7 !important;
            border-left: 4px solid #e63946;
        }
        #tableFilters input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
            box-sizing: border-box;
        }
        #tableFilters th {
            background: #f5f5f5;
            padding: 5px;
            cursor: default;
        }
        #tableFilters th:hover {
            background: #f5f5f5;
        }
        #listViewMapButton {
            padding: 6px 12px;
            border-radius: 4px;
            border: 2px solid #e63946;
            background: #fff;
            color: #111;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        #listViewMapButton:hover {
            background: #e63946;
            color: white;
        }
        #copyNotification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10001;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #copyNotification.show {
            opacity: 1;
        }

        /* Mobile List View Styles */
        #mobileCardsContainer {
            display: none;
        }
        #mobileFiltersSection {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        #mobileFiltersToggle {
            width: 100%;
            padding: 8px 10px;
            background: #e63946;
            color: white;
            border: none;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #mobileFiltersToggle:hover {
            background: #d62839;
        }
        #mobileFiltersContent {
            padding: 10px;
            display: none;
        }
        #mobileFiltersContent.show {
            display: block;
        }
        #mobileFiltersContent input,
        #mobileFiltersContent select {
            width: 100%;
            padding: 6px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }
        #mobileFiltersContent label {
            display: block;
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 12px;
        }
        #mobileColumnFilters {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        #mobileColumnFilters .filter-group {
            margin-bottom: 8px;
        }
        #mobileSortSection {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        #mobileSortSection select {
            flex: 1;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }
        #mobileSortDirection {
            padding: 6px 10px;
            background: #fff;
            border: 2px solid #e63946;
            color: #111;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        #mobileSortDirection:hover {
            background: #e63946;
            color: white;
        }
        .property-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        .property-card:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .property-card.selected {
            background: #ffe5e7;
            border-color: #e63946;
            border-width: 2px;
            box-shadow: 0 3px 8px rgba(230, 57, 70, 0.3);
        }
        .property-card-field {
            margin-bottom: 1px;
            line-height: 1.3;
        }
        .property-card-field-name {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            display: inline;
        }
        .property-card-field-value {
            color: #333;
            font-size: 14px;
            display: inline;
            word-wrap: break-word;
        }
        .property-card-notes {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #e63946;
        }
        .property-card-notes-title {
            font-weight: bold;
            color: #e63946;
            font-size: 13px;
            margin-bottom: 6px;
        }
        .property-card-note {
            margin-bottom: 6px;
            padding: 6px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .property-card-note-author {
            font-weight: bold;
            color: #e63946;
            font-size: 12px;
        }
        .property-card-note-text {
            color: #333;
            font-size: 13px;
            margin-top: 4px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #listViewContainer {
                padding: 10px;
            }
            #listViewHeader h2 {
                font-size: 16px;
            }
            #listViewHeader > div {
                flex-wrap: wrap;
                gap: 10px;
            }
            #tableContainer {
                display: none;
            }
            #mobileCardsContainer {
                display: block;
            }
            #listViewMapButton {
                padding: 4px 8px;
                font-size: 12px;
            }
            #copyNotification {
                bottom: 80px;
                right: 10px;
                left: 10px;
                text-align: center;
                z-index: 99999;
            }
        }

        @media (max-width: 480px) {
            #mobileSortSection {
                flex-direction: column;
            }
            #mobileSortSection select,
            #mobileSortDirection {
                width: 100%;
            }
        }

    </style>
</head>
<body>
    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
        <p>Loading property data...</p>
        <p style="font-size: 14px; margin-top: 15px;">A London Renters Union project</p>
        <p style="font-size: 14px; max-width: 400px; padding-left: 15px; padding-right: 15px; text-align: center; line-height: 1.4; color: #666;">
            Licensing data on public registers is often out of date.<br>
            Unlicensed properties are a major problem, please bear this in mind if using these maps for outreach.
        </p>
    </div>

    <div id="copyNotification">Copied to clipboard!</div>

    <!-- Add Note Modal for List View -->
    <div id="addNoteModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Note</h3>
                <button class="modal-close-btn" id="closeNoteModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalPropertyAddress" style="margin-bottom: 15px; font-weight: bold; color: #333;"></div>
                <input type="text" id="modalNoteAuthorInput" placeholder="Your name" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;" />
                <textarea id="modalNoteTextInput" placeholder="Enter your note on doorknocking/licensing etc..." style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; min-height: 100px; resize: vertical;"></textarea>
                <button id="modalSubmitNoteBtn" style="padding: 10px 20px; background: #e63946; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">Submit Note</button>
                <div id="modalNoteFormMessage" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <div id="controls">
        <div id="title"><a href="https://github.com/codev/licensemap">License Map</a> - An <a href="https://londonrentersunion.org" target="_blank">LRU</a> project</div>
        <select id="boroughSelector">
            <option value="brent">Brent</option>
            <option value="hackney" selected="selected">Hackney</option>
            <option value="haringey">Haringey</option>
            <option value="islington">Islington</option>
            <option value="lambeth">Lambeth</option>
            <option value="lewisham">Lewisham</option>
            <option value="newham">Newham</option>
            <option value="towerhamlets">Tower Hamlets</option>
            <option value="walthamforest">Waltham Forest</option>
            <option value="westminster">Westminster</option>
        </select>
        <button id="viewToggle">Switch to List View</button>
        <select id="landlordFilter">
            <option value="">&lt;All landlords...&gt;</option>
        </select>
        <select id="agentFilter">
            <option value="">&lt;All agents...&gt;</option>
        </select>
        <select id="noteFilter">
            <option value="">All properties</option>
            <option value="with">With notes</option>
            <option value="without">Without notes</option>
        </select>
        <input type="text" id="postcodeFilter" placeholder="Postcode">
        <span id="resultCount"></span>
        <div id="mapLicensingInfo"></div>
    </div>
    <div id="map"></div>

    <div id="listViewContainer" class="hidden">
        <div id="listViewHeader">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2 style="margin: 0; font-size: 18px;">Property List</h2>
                <button id="listViewMapButton">Switch to Map View</button>
            </div>
            <div style="margin-bottom: 10px;">
                <label for="listViewBoroughSelector" style="margin-right: 5px; font-weight: bold;">Borough:</label>
                <select id="listViewBoroughSelector" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px;">
                    <option value="brent">Brent</option>
                    <option value="hackney" selected="selected">Hackney</option>
                    <option value="haringey">Haringey</option>
                    <option value="islington">Islington</option>
                    <option value="lambeth">Lambeth</option>
                    <option value="lewisham">Lewisham</option>
                    <option value="newham">Newham</option>
                    <option value="towerhamlets">Tower Hamlets</option>
                    <option value="walthamforest">Waltham Forest</option>
                </select>
                <span id="listViewResultCount" style="margin-left: 10px; font-size: 13px; color: #666;"></span>
                <span id="listViewLicensingInfo" style="margin-left: 10px; font-size: 13px;"></span>
            </div>
        </div>
        <div id="tableContainer">
            <table id="propertyTable">
                <thead>
                    <tr id="tableHeaders"></tr>
                    <tr id="tableFilters"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="mobileCardsContainer">
            <div id="mobileFiltersSection">
                <button id="mobileFiltersToggle">
                    <span>Filters</span>
                    <span id="mobileFiltersIcon">▼</span>
                </button>
                <div id="mobileFiltersContent">
                    <label for="mobileGlobalSearch">Search All Fields:</label>
                    <input type="text" id="mobileGlobalSearch" placeholder="Search all fields...">

                    <div id="mobileColumnFilters">
                        <label style="font-size: 13px; color: #e63946; margin-bottom: 5px;">Filter by Column:</label>
                        <!-- Column filters will be dynamically added here -->
                    </div>

                    <label for="mobileNotesFilter">Notes:</label>
                    <select id="mobileNotesFilter">
                        <option value="">All properties</option>
                        <option value="has_notes">Has notes</option>
                        <option value="no_notes">No notes</option>
                    </select>

                    <button id="mobileClearFilters" style="width: 100%; padding: 6px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin-top: 5px;">Clear All Filters</button>
                </div>
            </div>

            <div id="mobileSortSection">
                <select id="mobileSortColumn">
                    <option value="">Sort by...</option>
                </select>
                <button id="mobileSortDirection" data-direction="asc">↑ Asc</button>
            </div>

            <div id="mobileResultCount" style="margin-bottom: 10px; font-size: 13px; color: #666;"></div>

            <div id="mobileCardsContent"></div>
        </div>
    </div>

    <div id="notesPanel" class="hidden">
        <h3>
            <span>Property Notes</span>
            <button class="close-btn" id="closeNotesBtn" title="Close notes panel">&times;</button>
        </h3>
        <div id="notesPanelContent">
            <p class="no-property">Click on a property marker to view and add notes.</p>
        </div>
        <div class="note-form">
            <h4 style="margin: 0 0 8px 0; font-size: 14px;">Add a Note</h4>
            <input type="text" id="noteAuthorInput" placeholder="Your name" />
            <textarea id="noteTextInput" placeholder="Enter your note on doorknocking/licensing etc..."></textarea>
            <button id="submitNoteBtn" disabled>Submit Note</button>
            <div id="noteFormMessage"></div>
        </div>
    </div>

    <script>
        // Debounce utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // init map
        const map = L.map('map').setView([0, 0], 2);
        
        // Add OSM tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let allData = [];
        let allMarkers = [];
        let markerClusterGroup = L.markerClusterGroup();

        // Notes feature variables
        // IMPORTANT: Replace this URL with your deployed Google Apps Script web app URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqePCb9IMNEZvovJjixCX6BIBP7GchaVNhdnNu4NOwyBTpO9xuT-baPtwswPP8CVxr/exec';
        let notesData = {}; // Will store notes indexed by address
        let selectedProperty = null; // Currently selected property for note submission

        // List view variables
        let currentView = 'map'; // 'map' or 'list'
        let tableColumns = [];
        let tableFilters = {};
        let tableSortColumn = null;
        let tableSortDirection = 'asc';

        // Mobile view variables
        let mobileGlobalFilter = '';
        let mobileColumnFilters = {}; // Per-column filters
        let mobileNotesFilter = '';
        let mobileSortCol = '';
        let mobileSortDir = 'asc';

        // Borough licensing register URLs
        const LICENSING_URLS = {
            "Hackney": "https://www.hackney.gov.uk/property-licensing",
            "Haringey": "https://www.haringey.gov.uk/housing/property-licensing",
            "Barking and Dagenham": "https://www.lbbd.gov.uk/private-sector-housing/licensing",
            "Croydon": "https://www.croydon.gov.uk/housing/landlords",
            "Ealing": "https://www.ealing.gov.uk/info/201086/housing_and_council_tax/3306/private_rented_property_licensing",
            "Enfield": "https://www.enfield.gov.uk/services/housing/private-rented-property-licensing",
            "Greenwich": "http://www.royalgreenwich.gov.uk/info/200069/multiple_occupancy_homes/937/hmo_licensing",
            "Havering": "https://www.havering.gov.uk/info/20060/information_for_landlords/336/guidance_on_letting_your_property_to_multiple_residents",
            "Islington": "https://www.islington.gov.uk/housing/private-sector-housing/landlords/houses-in-multiple-occupation-hmos",
            "Kensington and Chelsea": "http://www.rbkc.gov.uk/housing/livinginhealthyhomes/housesinmultipleoccupation.aspx",
            "Lambeth": "https://www.lambeth.gov.uk/housing/landlords-licensing",
            "Lewisham": "https://lewisham.gov.uk/myservices/housing/private-tenants-and-landlords/landlords",
            "Southwark": "https://www.southwark.gov.uk/housing/private-tenants-and-landlords/private-rented-property-licensing",
            "Waltham Forest": "https://www.walthamforest.gov.uk/service-categories/private-landlords",
            "Westminster": "https://www.westminster.gov.uk/housing/private-sector-housing",
            "Newham": "http://www.newham.gov.uk/Pages/Services/Private-rented-property-licensing.aspx",
            "Tower Hamlets": "https://www.towerhamlets.gov.uk/lgnl/housing/Private-tenants-landlords-and-homeowners/Private-Landlords/Landlord_Licensing_Schemes.aspx",
            "Brent": "https://www.brent.gov.uk/housing/landlords/property-licensing#findoutifyouneedalicence",
            "Redbridge": "https://www.redbridge.gov.uk/housing/private-rentals/",
        };
      const LICENSING_EMAILS = {
            "Hackney": "property.licensing@hackney.gov.uk",
            "Haringey": "propertylicensing@haringey.gov.uk",
            "Barking and Dagenham": "PRPL@lbbd.gov.uk",
            "Croydon": "hmo@croydon.gov.uk",
            "Ealing": "prslicensing@ealing.gov.uk",
            "Enfield": "prsh@enfield.gov.uk",
            "Greenwich": "private-rented-property-licensing@royalgreenwich.gov.uk",
            "Havering": "landlordlicensing@havering.gov.uk",
            "Islington": "property.licensing@islington.gov.uk",
            "Kensington and Chelsea": "hmolicensing@rbkc.gov.uk",
            "Lambeth": "prslicensing@lambeth.gov.uk",
            "Lewisham": "pshe@lewisham.gov.uk",
            "Southwark": "resi@southwark.gov.uk",
            "Waltham Forest": "propertylicensing@walthamforest.gov.uk",
            "Westminster": "HMO@westminster.gov.uk ",
            "Newham": "propertylicensing@newham.gov.uk",
            "Tower Hamlets": "housinglicensing@towerhamlets.gov.uk",
            "Brent": "prslicensing@brent.gov.uk",
            "Redbridge": "prslicensing@redbridge.gov.uk",
        };
      const OTHER_LICENSE_DETAILS = {
            "Hackney": "",
            "Haringey": "",
            "Barking and Dagenham": "",
            "Croydon": "",
            "Ealing": "",
            "Enfield": "",
            "Greenwich": "",
            "Havering": "",
            "Islington": "",
            "Kensington and Chelsea": "",
            "Lambeth": "",
            "Lewisham": "",
            "Southwark": "",
            "Waltham Forest": "",
            "Westminster": "",
            "Newham": "",
            "Tower Hamlets": "",
            "Brent": "",
            "Redbridge": "",
        };
      const REGISTER_URLS = {
            "Hackney": "https://propertylicensing.hackney.gov.uk/public-register",
            "Haringey": "https://propertylicensing.haringey.gov.uk/public-register",
            "Barking and Dagenham": "https://lbbd.metastreet.co.uk/public-register",
            "Croydon": "https://landlordlicensing.croydon.gov.uk/public-register",
            "Ealing": "https://ealing.metastreet.co.uk/public-register",
            "Enfield": "https://enfield.metastreet.co.uk/public-register",
            "Greenwich": "https://greenwich.metastreet.co.uk/public-register",
            "Havering": "https://housingpropertylicence.havering.gov.uk/public-register",
            "Islington": "https://propertylicensing.islington.gov.uk/public-register",
            "Kensington and Chelsea": "https://rbkc.metastreet.co.uk/public-register",
            "Lambeth": "https://hmolicensing.lambeth.gov.uk/public-register",
            "Lewisham": "https://lewisham.metastreet.co.uk/public-register",
            "Southwark": "https://southwark.metastreet.co.uk/public-register",
            "Waltham Forest": "https://propertylicensing.walthamforest.gov.uk/public-register",
            "Westminster": "https://westminster.metastreet.co.uk/public-register",
            "Newham": "https://www.newham.gov.uk/landlords-newham/rented-property-licensing/6",
            "Tower Hamlets": "https://www.towerhamlets.gov.uk/lgnl/housing/Private-tenants-landlords-and-homeowners/Private-Landlords/Private-landlords.aspx",
            "Brent": "https://www.brent.gov.uk/-/media/files/resident-documents/housing-documents/online-register-of-licenced-properties.pdf?",
            "Redbridge": "https://propertylicensing.redbridge.gov.uk/online-application/public-register/",
        };
        
        // Add jitter to coordinates
        function addJitter(value) {
            return value;
            // 2025-11-06 disable jitter
            //return value + (Math.random() - 0.5) * 0.0009;
        }
        
        // Load notes from Google Sheets
        // refreshMarkers: if true, will rebuild all markers (only on initial load)
        async function loadNotes(refreshMarkers = false) {
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                console.warn('Google Apps Script URL not configured. Notes feature will not work.');
                return;
            }

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();

                if (data.success && data.notes) {
                    // Index notes by address for quick lookup
                    notesData = {};
                    data.notes.forEach(note => {
                        const address = note.address;
                        if (!notesData[address]) {
                            notesData[address] = [];
                        }
                        notesData[address].push(note);
                    });

                    console.log(`Loaded ${data.notes.length} notes for ${Object.keys(notesData).length} properties`);

                    // Only update markers on initial load, not during auto-refresh
                    if (refreshMarkers) {
                        updateMarkers();
                    } else {
                        // On auto-refresh, only update the notes panel if it's currently open
                        if (!document.getElementById('notesPanel').classList.contains('hidden') && selectedProperty) {
                            updateNotesPanel();
                        }
                    }
                } else {
                    console.error('Error loading notes:', data.error);
                }
            } catch (error) {
                console.error('Error fetching notes:', error);
            }
        }

        // Get notes for a specific address
        function getNotesForAddress(address) {
            return notesData[address] || [];
        }

        // Open notes panel for a specific property (called from popup button)
        function openNotesForProperty(address) {
            // Find the property data by address
            const property = allData.find(row => (row.Address || row.address) === address);
            if (property) {
                selectedProperty = property;
                document.getElementById('notesPanel').classList.remove('hidden');
                updateNotesPanel();
            }
        }

        // Update the notes panel display
        function updateNotesPanel() {
            const contentDiv = document.getElementById('notesPanelContent');
            const submitBtn = document.getElementById('submitNoteBtn');

            if (!selectedProperty) {
                contentDiv.innerHTML = '<p class="no-property">Click on a property marker to view and add notes.</p>';
                submitBtn.disabled = true;
                return;
            }

            const address = selectedProperty.Address || selectedProperty.address;
            const notes = getNotesForAddress(address);

            if (notes.length === 0) {
                contentDiv.innerHTML = `<p class="no-property">No notes yet for this property.</p>`;
            } else {
                let html = '';
                notes.forEach(note => {
                    const timestamp = new Date(note.timestamp).toLocaleString();
                    html += `
                        <div class="note-item">
                            <div class="note-author">${note.name}</div>
                            <div class="note-text">${note.note}</div>
                            <div class="note-time">${timestamp}</div>
                        </div>
                    `;
                });
                contentDiv.innerHTML = html;
            }

            submitBtn.disabled = false;
        }

        // Update map licensing info in control panel
        function updateMapLicensingInfo(boroughKey) {
            // Convert borough key to proper borough name
            const boroughNames = {
                'brent': 'Brent',
                'hackney': 'Hackney',
                'haringey': 'Haringey',
                'islington': 'Islington',
                'lambeth': 'Lambeth',
                'lewisham': 'Lewisham',
                'newham': 'Newham',
                'towerhamlets': 'Tower Hamlets',
                'walthamforest': 'Waltham Forest'
            };

            const boroughName = boroughNames[boroughKey] || boroughKey;
            const licensingUrl = LICENSING_URLS[boroughName];
            const registerUrl = REGISTER_URLS[boroughName];
            const email = LICENSING_EMAILS[boroughName];

            let html = '<strong>' + boroughName + ':</strong> ';
            const links = [];

            if (licensingUrl) {
                links.push('<a href="' + licensingUrl + '" target="_blank">Council website</a>');
            }

            if (registerUrl) {
                links.push('<a href="' + registerUrl + '" target="_blank">Public register</a>');
            }

            html += links.join(' - ');

            if (email) {
                html += ' - <span>Email:</span> <span style="overflow-wrap: break-word; word-wrap: break-word;">' + email + '</span>';
            }

            const mapInfo = document.getElementById('mapLicensingInfo');
            if (mapInfo) {
                mapInfo.innerHTML = html;
            }
        }

        // Filter and display markers
        function updateMarkers() {
            const landlordFilter = document.getElementById('landlordFilter').value;
            const agentFilter = document.getElementById('agentFilter').value;
            const postcodeFilter = document.getElementById('postcodeFilter').value.replace(/\s/g, '').toUpperCase();
            const noteFilter = document.getElementById('noteFilter').value;

            // Clear existing markers from cluster group
            markerClusterGroup.clearLayers();
            allMarkers = [];

            // Filter and add markers (using pre-normalized postcodes)
            const filteredData = allData.filter(row => {
                const matchesLandlord = !landlordFilter || row.Landlord === landlordFilter;
                const matchesAgent = !agentFilter || row.Agent === agentFilter;
                const matchesPostcode = !postcodeFilter || (row._normalizedPostcode && row._normalizedPostcode.startsWith(postcodeFilter));

                // Note filter
                let matchesNotes = true;
                if (noteFilter) {
                    const address = row.Address || row.address;
                    const hasNotes = address && notesData[address] && notesData[address].length > 0;
                    if (noteFilter === 'with') {
                        matchesNotes = hasNotes;
                    } else if (noteFilter === 'without') {
                        matchesNotes = !hasNotes;
                    }
                }

                return matchesLandlord && matchesAgent && matchesPostcode && matchesNotes;
            });

            filteredData.forEach(row => {
                const lat = addJitter(row.latitude || row.Latitude || row.lat);
                const lng = addJitter(row.longitude || row.Longitude || row.lng || row.lon);

                if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const address = row.Address || row.address;
                    const notes = getNotesForAddress(address);
                    const noteCount = notes.length;

                    let popupContent = '<div style="max-width: 250px;">';
                    Object.keys(row).forEach(key => {
                        if (key.toLowerCase() !== 'borough' && key.toLowerCase() !== 'latitude' && key.toLowerCase() !== 'longitude' && !key.startsWith('_') && row[key]) {
                            popupContent += `<strong>${key}:</strong> ${row[key]}<br>`;
                        }
                    });

                    // Add notes count to popup
                    if (noteCount > 0) {
                        popupContent += `<br><strong style="color: #e63946;">${noteCount} note${noteCount !== 1 ? 's' : ''}</strong>`;
                    }

                    // Add "View Notes" button
                    popupContent += `<br><button class="view-notes-btn" onclick="openNotesForProperty('${address.replace(/'/g, "\\'")}')">View Notes</button>`;

                    popupContent += '</div>';

                    const marker = L.marker([lat, lng]);
                    marker.bindPopup(popupContent);

                    // Store property data on marker for click handler
                    marker.propertyData = row;

                    // Add click handler to show notes panel on wider screens
                    marker.on('click', function() {
                        selectedProperty = this.propertyData;
                        // Only auto-open notes panel on desktop
                        if (window.innerWidth >= 950) {
                            document.getElementById('notesPanel').classList.remove('hidden');
                            updateNotesPanel();
                        }
                    });

                    markerClusterGroup.addLayer(marker);
                    allMarkers.push(marker);
                }
            });

            // Add cluster group to map
            map.addLayer(markerClusterGroup);

            // Fit map to show all markers
            if (allMarkers.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }

            // Update result count
            const resultCountElement = document.getElementById('resultCount');
            if (landlordFilter || agentFilter || postcodeFilter || noteFilter) {
                resultCountElement.textContent = `${filteredData.length} result${filteredData.length !== 1 ? 's' : ''}`;
            } else {
                resultCountElement.textContent = '';
            }
        }

        // Variables for slim-select instances
        let landlordSlimSelect = null;
        let agentSlimSelect = null;

        // Show/hide loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Load CSV for a specific borough
        function loadBorough(borough, isInitialLoad = false) {
            showLoading();

            // Track start time for minimum loading duration on initial load
            const startTime = Date.now();

            // Clear existing data
            allData = [];
            markerClusterGroup.clearLayers();
            allMarkers = [];
            document.getElementById('postcodeFilter').value = '';

            // Clear table filters and sort
            tableFilters = {};
            tableSortColumn = null;
            tableSortDirection = 'asc';

            // Clear mobile filters and sort
            mobileGlobalFilter = '';
            mobileColumnFilters = {};
            mobileNotesFilter = '';
            mobileSortCol = '';
            mobileSortDir = 'asc';
            if (document.getElementById('mobileGlobalSearch')) {
                document.getElementById('mobileGlobalSearch').value = '';
                document.getElementById('mobileNotesFilter').value = '';
                document.getElementById('mobileColumnFilters').innerHTML = '<label style="font-size: 13px; color: #e63946; margin-bottom: 5px;">Filter by Column:</label>';
                const mobileSortSelect = document.getElementById('mobileSortColumn');
                mobileSortSelect.innerHTML = '<option value="">Sort by...</option>'; // Reset dropdown
                document.getElementById('mobileSortDirection').textContent = '↑ Asc';
                document.getElementById('mobileSortDirection').dataset.direction = 'asc';
            }

            const csvUrl = `https://raw.githubusercontent.com/codev/licensemap/main/${borough}.csv`;

            Papa.parse(csvUrl, {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: async results => {
                    allData = results.data;

                    // Pre-normalize postcodes for faster filtering
                    allData.forEach(row => {
                        if (row.Postcode) {
                            row._normalizedPostcode = row.Postcode.replace(/\s/g, '').toUpperCase();
                        }
                    });

                    console.log(`Loaded ${allData.length} properties from ${borough}.csv`);

                    // Count occurrences and populate dropdowns
                    const landlordCounts = {};
                    const agentCounts = {};

                    allData.forEach(row => {
                        if (row.Landlord) {
                            landlordCounts[row.Landlord] = (landlordCounts[row.Landlord] || 0) + 1;
                        }
                        if (row.Agent) {
                            agentCounts[row.Agent] = (agentCounts[row.Agent] || 0) + 1;
                        }
                    });

                    const landlordSelect = document.getElementById('landlordFilter');
                    const agentSelect = document.getElementById('agentFilter');

                    // Clear existing options (except first one)
                    landlordSelect.innerHTML = '<option value="">&lt;All landlords...&gt;</option>';
                    agentSelect.innerHTML = '<option value="">&lt;All agents...&gt;</option>';

                    // Sort by count (highest first) and populate
                    Object.entries(landlordCounts)
                        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
                        .forEach(([landlord, count]) => {
                            const option = document.createElement('option');
                            option.value = landlord;
                            const displayName = landlord.length > 30 ? landlord.substring(0, 30) + '...' : landlord;
                            option.textContent = `${displayName} (${count})`;
                            option.title = landlord;
                            landlordSelect.appendChild(option);
                        });

                    Object.entries(agentCounts)
                        .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
                        .forEach(([agent, count]) => {
                            const option = document.createElement('option');
                            option.value = agent;
                            const displayName = agent.length > 30 ? agent.substring(0, 30) + '...' : agent;
                            option.textContent = `${displayName} (${count})`;
                            option.title = agent;
                            agentSelect.appendChild(option);
                        });

                    // Destroy existing slim-select instances if they exist
                    if (landlordSlimSelect) {
                        landlordSlimSelect.destroy();
                    }
                    if (agentSlimSelect) {
                        agentSlimSelect.destroy();
                    }

                    // Initialize slim-select for landlord dropdown
                    landlordSlimSelect = new SlimSelect({
                        select: '#landlordFilter',
                        settings: {
                            showSearch: true,
                            searchPlaceholder: 'Search landlords...',
                            searchHighlight: true,
                            closeOnSelect: true
                        },
                        events: {
                            afterChange: () => {
                                agentSlimSelect.setSelected('');
                                document.getElementById('postcodeFilter').value = '';
                                updateMarkers();
                            }
                        }
                    });

                    // Initialize slim-select for agent dropdown
                    agentSlimSelect = new SlimSelect({
                        select: '#agentFilter',
                        settings: {
                            showSearch: true,
                            searchPlaceholder: 'Search agents...',
                            searchHighlight: true,
                            closeOnSelect: true
                        },
                        events: {
                            afterChange: () => {
                                landlordSlimSelect.setSelected('');
                                document.getElementById('postcodeFilter').value = '';
                                updateMarkers();
                            }
                        }
                    });

                    // Initial display
                    updateMarkers();

                    // Also render table/cards if in list view
                    if (currentView === 'list') {
                        updateLicensingInfo(borough);
                        renderTable();
                        renderMobileCards();
                    }

                    // On initial load, wait for both notes to load and minimum 6-second duration
                    if (isInitialLoad) {
                        // Create a promise for the minimum loading time
                        const minLoadTime = new Promise(resolve => {
                            const elapsed = Date.now() - startTime;
                            const remaining = Math.max(0, 6000 - elapsed);
                            setTimeout(resolve, remaining);
                        });

                        // Wait for both notes to load and minimum time to pass
                        await Promise.all([
                            loadNotes(true), // Pass true to refresh markers on initial load
                            minLoadTime
                        ]);
                    } else {
                        // On borough change, don't wait for notes
                        loadNotes(true); // Pass true to refresh markers
                    }

                    hideLoading();
                },
                error: error => {
                    console.error('Error loading CSV:', error);
                    alert(`Failed to load ${borough} data. Please try again.`);
                    hideLoading();
                }
            });
        }

        // Add event listener for note filter (one time setup)
        document.getElementById('noteFilter').addEventListener('change', () => {
            updateMarkers();
        });

        // Add debounced event listener for postcode input (one time setup)
        const postcodeInput = document.getElementById('postcodeFilter');
        const debouncedUpdate = debounce(() => {
            if (landlordSlimSelect) landlordSlimSelect.setSelected('');
            if (agentSlimSelect) agentSlimSelect.setSelected('');
            updateMarkers();
        }, 300);
        postcodeInput.addEventListener('input', debouncedUpdate);

        // Add event listener for borough selector
        document.getElementById('boroughSelector').addEventListener('change', function() {
            const selectedBorough = this.value;
            // Sync with list view borough selector
            document.getElementById('listViewBoroughSelector').value = selectedBorough;
            // Update map licensing info
            updateMapLicensingInfo(selectedBorough);
            loadBorough(selectedBorough);
        });

        // Load default borough (Hackney) on page load
        // Reset the dropdown to Hackney to prevent browser form persistence from showing wrong borough
        document.getElementById('boroughSelector').value = 'hackney';
        updateMapLicensingInfo('hackney');
        loadBorough('hackney', true); // true = isInitialLoad, wait for notes and show loading for min 6 seconds

        // Auto-refresh notes every 2 minutes when page is visible
        // 2025-11-21 Disabled by Marc, refresh page to get new notes
        // function setupNotesAutoRefresh() {
        //     setInterval(() => {
        //         // Only refresh if page is visible
        //         if (!document.hidden) {
        //             loadNotes();
        //         }
        //     }, 120000); // 2 minutes (120 seconds)
        // }

        // Start auto-refresh after initial load
        // 2025-11-21 Disabled by Marc, refresh page to get new notes
        // setupNotesAutoRefresh();

        // Close button functionality
        document.getElementById('closeNotesBtn').addEventListener('click', function() {
            document.getElementById('notesPanel').classList.add('hidden');
            selectedProperty = null;
        });

        // Close notes panel on mobile by default
        if (window.innerWidth < 950) {
            document.getElementById('notesPanel').classList.add('hidden');
        }

        // Note submission functionality
        document.getElementById('submitNoteBtn').addEventListener('click', async function() {
            const authorInput = document.getElementById('noteAuthorInput');
            const textInput = document.getElementById('noteTextInput');
            const messageDiv = document.getElementById('noteFormMessage');

            const author = authorInput.value.trim();
            const noteText = textInput.value.trim();

            // Clear previous messages
            messageDiv.innerHTML = '';

            // Validate inputs
            if (!author || !noteText) {
                messageDiv.innerHTML = '<div class="error-message">Please enter both your name and a note.</div>';
                return;
            }

            if (!selectedProperty) {
                messageDiv.innerHTML = '<div class="error-message">No property selected.</div>';
                return;
            }

            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                messageDiv.innerHTML = '<div class="error-message">Google Apps Script URL not configured.</div>';
                return;
            }

            const address = selectedProperty.Address || selectedProperty.address;

            // Disable button during submission
            this.disabled = true;
            this.textContent = 'Submitting...';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        name: author,
                        note: noteText
                    })
                });

                // Note: With no-cors mode, we can't read the response
                // But we can assume success and reload notes
                messageDiv.innerHTML = '<div class="success-message">Note submitted successfully!</div>';

                // Clear form
                authorInput.value = '';
                textInput.value = '';

                // Reload notes after a short delay to allow Google Sheets to update
                setTimeout(() => {
                    loadNotes();
                    messageDiv.innerHTML = '';
                }, 1500);

            } catch (error) {
                console.error('Error submitting note:', error);
                messageDiv.innerHTML = '<div class="error-message">Error submitting note. Please try again.</div>';
            } finally {
                this.disabled = false;
                this.textContent = 'Submit Note';
            }
        });

        // ==================== LIST VIEW FUNCTIONALITY ====================

        // Update licensing info display
        function updateLicensingInfo(boroughKey) {
            // Convert borough key to proper borough name
            const boroughNames = {
                'brent': 'Brent',
                'hackney': 'Hackney',
                'haringey': 'Haringey',
                'islington': 'Islington',
                'lambeth': 'Lambeth',
                'lewisham': 'Lewisham',
                'newham': 'Newham',
                'towerhamlets': 'Tower Hamlets',
                'walthamforest': 'Waltham Forest'
            };

            const boroughName = boroughNames[boroughKey] || boroughKey;
            const licensingUrl = LICENSING_URLS[boroughName];
            const registerUrl = REGISTER_URLS[boroughName];
            const email = LICENSING_EMAILS[boroughName];

            let html = '<strong>' + boroughName + ':</strong> ';
            const links = [];

            if (licensingUrl) {
                links.push('<a href="' + licensingUrl + '" target="_blank" style="color: #e63946; text-decoration: none;">Council website</a>');
            }

            if (registerUrl) {
                links.push('<a href="' + registerUrl + '" target="_blank" style="color: #e63946; text-decoration: none;">Public register</a>');
            }

            html += links.join(' - ');

            if (email) {
                html += ' - <span>Email:</span> <span style="overflow-wrap: break-word; word-wrap: break-word;">' + email + '</span>';
            }

            // Update desktop info (visible on both desktop and mobile)
            const desktopInfo = document.getElementById('listViewLicensingInfo');

            if (desktopInfo) {
                desktopInfo.innerHTML = html;
            }
        }

        // View toggle functionality
        function switchToListView() {
            currentView = 'list';
            document.getElementById('map').classList.add('hidden');
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('listViewContainer').classList.remove('hidden');
            document.getElementById('viewToggle').textContent = 'Switch to Map View';

            // Sync borough selector
            const mapBorough = document.getElementById('boroughSelector').value;
            document.getElementById('listViewBoroughSelector').value = mapBorough;

            // Update licensing info
            updateLicensingInfo(mapBorough);

            // Render table for desktop, cards for mobile
            renderTable();
            renderMobileCards();
        }

        function switchToMapView() {
            currentView = 'map';
            document.getElementById('listViewContainer').classList.add('hidden');
            document.getElementById('map').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('viewToggle').textContent = 'Switch to List View';
        }

        document.getElementById('viewToggle').addEventListener('click', function() {
            if (currentView === 'map') {
                switchToListView();
            } else {
                switchToMapView();
            }
        });

        // List view map button
        document.getElementById('listViewMapButton').addEventListener('click', function() {
            switchToMapView();
        });

        // List view borough selector
        document.getElementById('listViewBoroughSelector').addEventListener('change', function() {
            const selectedBorough = this.value;
            // Sync with map borough selector
            document.getElementById('boroughSelector').value = selectedBorough;
            // Update licensing info
            updateLicensingInfo(selectedBorough);
            loadBorough(selectedBorough);
        });

        // Render table from allData
        function renderTable() {
            if (allData.length === 0) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="100">No data loaded</td></tr>';
                return;
            }

            // Determine columns from first row, excluding internal ones and Borough
            const firstRow = allData[0];
            tableColumns = Object.keys(firstRow).filter(key =>
                !key.startsWith('_') &&
                key.toLowerCase() !== 'latitude' &&
                key.toLowerCase() !== 'longitude' &&
                key.toLowerCase() !== 'lat' &&
                key.toLowerCase() !== 'lng' &&
                key.toLowerCase() !== 'lon' &&
                key.toLowerCase() !== 'borough'
            );

            // Add Notes column at the end
            tableColumns.push('Notes');
            // Add Actions column
            tableColumns.push('Actions');

            // Render headers
            const headersRow = document.getElementById('tableHeaders');
            headersRow.innerHTML = '';
            tableColumns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                if (column !== 'Actions') {
                    th.className = 'sortable';
                    th.dataset.column = column;
                    th.addEventListener('click', () => sortTable(column));
                }
                headersRow.appendChild(th);
            });

            // Render filter inputs
            const filtersRow = document.getElementById('tableFilters');
            filtersRow.innerHTML = '';
            tableColumns.forEach(column => {
                const th = document.createElement('th');

                if (column === 'Actions') {
                    // Empty cell for Actions column
                    filtersRow.appendChild(th);
                    return;
                } else if (column === 'Notes') {
                    // Special dropdown filter for Notes column
                    const select = document.createElement('select');
                    select.style.width = '100%';
                    select.style.padding = '5px';
                    select.style.border = '1px solid #ccc';
                    select.style.borderRadius = '3px';
                    select.style.fontSize = '12px';
                    select.innerHTML = `
                        <option value="">All</option>
                        <option value="has_notes">Has notes</option>
                        <option value="no_notes">No notes</option>
                    `;
                    select.addEventListener('change', (e) => {
                        tableFilters[column] = e.target.value;
                        filterAndRenderTableRows();
                    });
                    th.appendChild(select);
                } else {
                    // Regular text input for other columns
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = `Filter ${column}...`;
                    input.dataset.column = column;
                    input.addEventListener('input', debounce((e) => {
                        tableFilters[column] = e.target.value.toLowerCase();
                        filterAndRenderTableRows();
                    }, 300));
                    th.appendChild(input);
                }

                filtersRow.appendChild(th);
            });

            // Render data rows
            filterAndRenderTableRows();
        }

        // Filter and render table rows
        function filterAndRenderTableRows() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Apply filters
            let filteredData = allData.filter(row => {
                for (let column in tableFilters) {
                    const filterValue = tableFilters[column];

                    if (column === 'Notes') {
                        // Special handling for Notes filter
                        if (filterValue) {
                            const address = row.Address || row.address;
                            const hasNotes = address && notesData[address] && notesData[address].length > 0;

                            if (filterValue === 'has_notes' && !hasNotes) {
                                return false;
                            } else if (filterValue === 'no_notes' && hasNotes) {
                                return false;
                            }
                        }
                    } else {
                        // Regular text filter for other columns
                        if (filterValue && row[column]) {
                            const cellValue = String(row[column]).toLowerCase();
                            if (!cellValue.includes(filterValue)) {
                                return false;
                            }
                        } else if (filterValue && !row[column]) {
                            return false;
                        }
                    }
                }
                return true;
            });

            // Apply sorting
            if (tableSortColumn) {
                filteredData.sort((a, b) => {
                    // Special handling for Notes column - sort by number of notes
                    if (tableSortColumn === 'Notes') {
                        const aAddress = a.Address || a.address;
                        const bAddress = b.Address || b.address;
                        const aNotesCount = (aAddress && notesData[aAddress]) ? notesData[aAddress].length : 0;
                        const bNotesCount = (bAddress && notesData[bAddress]) ? notesData[bAddress].length : 0;
                        return tableSortDirection === 'asc' ? aNotesCount - bNotesCount : bNotesCount - aNotesCount;
                    }

                    let aVal = a[tableSortColumn] || '';
                    let bVal = b[tableSortColumn] || '';

                    // Try to compare as numbers if possible
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return tableSortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                    }

                    // Otherwise compare as strings
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    if (aVal < bVal) return tableSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return tableSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Render rows
            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.dataset.rowIndex = index;

                // Store row data for clipboard copy
                tr.rowData = row;

                tr.addEventListener('click', () => highlightRow(tr, row));

                tableColumns.forEach(column => {
                    const td = document.createElement('td');

                    if (column === 'Notes') {
                        // Special handling for Notes column
                        const address = row.Address || row.address;
                        const notes = getNotesForAddress(address);

                        if (notes.length > 0) {
                            // Format notes for display with HTML
                            td.innerHTML = '';
                            notes.forEach((note, idx) => {
                                const noteDiv = document.createElement('div');
                                noteDiv.style.marginBottom = idx < notes.length - 1 ? '8px' : '0';
                                noteDiv.style.paddingBottom = idx < notes.length - 1 ? '8px' : '0';
                                noteDiv.style.borderBottom = idx < notes.length - 1 ? '1px solid #ddd' : 'none';

                                const noteName = document.createElement('div');
                                noteName.style.fontWeight = 'bold';
                                noteName.style.color = '#e63946';
                                noteName.style.fontSize = '12px';
                                noteName.textContent = `${note.name} - ${new Date(note.timestamp).toLocaleDateString()}`;

                                const noteText = document.createElement('div');
                                noteText.style.fontSize = '12px';
                                noteText.style.marginTop = '2px';
                                noteText.style.color = '#333';
                                noteText.textContent = note.note;

                                noteDiv.appendChild(noteName);
                                noteDiv.appendChild(noteText);
                                td.appendChild(noteDiv);
                            });
                            td.style.whiteSpace = 'normal';
                            td.style.minWidth = '250px';
                        } else {
                            td.textContent = '';
                        }
                    } else if (column === 'Actions') {
                        // Add "Add Note" button
                        const addNoteBtn = document.createElement('button');
                        addNoteBtn.textContent = 'Add Note';
                        addNoteBtn.className = 'add-note-btn';
                        addNoteBtn.style.padding = '5px 10px';
                        addNoteBtn.style.fontSize = '12px';
                        addNoteBtn.style.background = 'white';
                        addNoteBtn.style.color = '#111';
                        addNoteBtn.style.border = '2px solid #e63946';
                        addNoteBtn.style.borderRadius = '4px';
                        addNoteBtn.style.cursor = 'pointer';
                        addNoteBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent row click
                            openAddNoteModal(row);
                        });
                        addNoteBtn.addEventListener('mouseenter', function() {
                            this.style.background = '#e63946';
                            this.style.color = 'white';
                        });
                        addNoteBtn.addEventListener('mouseleave', function() {
                            this.style.background = 'white';
                            this.style.color = '#111';
                        });
                        td.appendChild(addNoteBtn);
                    } else {
                        td.textContent = row[column] || '';
                        td.title = row[column] || ''; // Tooltip for long values
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            // Update result count
            const resultCountElement = document.getElementById('listViewResultCount');
            const hasFilters = Object.values(tableFilters).some(v => v !== '');
            if (hasFilters) {
                resultCountElement.textContent = `${filteredData.length} of ${allData.length} properties`;
            } else {
                resultCountElement.textContent = `${allData.length} properties`;
            }
        }

        // Sort table by column
        function sortTable(column) {
            // Toggle sort direction if clicking same column, otherwise default to ascending
            if (tableSortColumn === column) {
                tableSortDirection = tableSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                tableSortColumn = column;
                tableSortDirection = 'asc';
            }

            // Update header classes
            document.querySelectorAll('#tableHeaders th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === column) {
                    th.classList.add(tableSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            // Re-render rows with new sort
            filterAndRenderTableRows();
        }

        // Highlight selected row and copy to clipboard
        function highlightRow(tr, rowData) {
            // Remove previous selection
            document.querySelectorAll('#tableBody tr').forEach(row => {
                row.classList.remove('selected');
            });

            // Add selection to clicked row
            tr.classList.add('selected');

            // Copy row data to clipboard
            if (rowData) {
                // Build clipboard text with all data (excluding internal fields)
                const clipboardLines = [];

                Object.keys(rowData).forEach(key => {
                    // Skip internal fields
                    if (!key.startsWith('_') &&
                        key.toLowerCase() !== 'latitude' &&
                        key.toLowerCase() !== 'longitude' &&
                        key.toLowerCase() !== 'lat' &&
                        key.toLowerCase() !== 'lng' &&
                        key.toLowerCase() !== 'lon') {

                        const value = rowData[key];
                        if (value !== null && value !== undefined && value !== '') {
                            clipboardLines.push(`${key}: ${value}`);
                        }
                    }
                });

                // Add notes if available
                const address = rowData.Address || rowData.address;
                const notes = getNotesForAddress(address);
                if (notes.length > 0) {
                    clipboardLines.push(''); // Empty line separator
                    clipboardLines.push('Notes:');
                    notes.forEach(note => {
                        clipboardLines.push(`  - ${note.name} (${new Date(note.timestamp).toLocaleString()}): ${note.note}`);
                    });
                }

                const clipboardText = clipboardLines.join('\n');

                // Copy to clipboard
                navigator.clipboard.writeText(clipboardText).then(() => {
                    console.log('Property details copied to clipboard');

                    // Show notification
                    const notification = document.getElementById('copyNotification');
                    notification.classList.add('show');

                    // Hide after 2 seconds
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy to clipboard:', err);
                });
            }
        }

        // ==================== MOBILE CARDS VIEW FUNCTIONALITY ====================

        // Check if mobile view
        function isMobileView() {
            return window.innerWidth <= 768;
        }

        // Render mobile cards
        function renderMobileCards() {
            if (allData.length === 0) {
                document.getElementById('mobileCardsContent').innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No data loaded</p>';
                return;
            }

            // Populate sort dropdown and column filters (only once)
            const mobileSortSelect = document.getElementById('mobileSortColumn');
            const mobileColumnFiltersDiv = document.getElementById('mobileColumnFilters');

            if (mobileSortSelect.options.length === 1) { // Only has "Sort by..."
                const firstRow = allData[0];
                const columns = Object.keys(firstRow).filter(key =>
                    !key.startsWith('_') &&
                    key.toLowerCase() !== 'latitude' &&
                    key.toLowerCase() !== 'longitude' &&
                    key.toLowerCase() !== 'lat' &&
                    key.toLowerCase() !== 'lng' &&
                    key.toLowerCase() !== 'lon' &&
                    key.toLowerCase() !== 'borough'
                );

                // Populate sort dropdown
                columns.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    mobileSortSelect.appendChild(option);
                });

                // Create column filter inputs
                columns.forEach(col => {
                    const filterGroup = document.createElement('div');
                    filterGroup.className = 'filter-group';

                    const label = document.createElement('label');
                    label.textContent = col + ':';
                    label.style.fontSize = '12px';

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = `Filter ${col}...`;
                    input.dataset.column = col;
                    input.addEventListener('input', debounce(function(e) {
                        const column = e.target.dataset.column;
                        mobileColumnFilters[column] = e.target.value.toLowerCase();
                        filterAndRenderMobileCards();
                    }, 300));

                    filterGroup.appendChild(label);
                    filterGroup.appendChild(input);
                    mobileColumnFiltersDiv.appendChild(filterGroup);
                });
            }

            filterAndRenderMobileCards();
        }

        // Filter and render mobile cards
        function filterAndRenderMobileCards() {
            const cardsContent = document.getElementById('mobileCardsContent');
            cardsContent.innerHTML = '';

            // Apply filters
            let filteredData = allData.filter(row => {
                // Global search filter
                if (mobileGlobalFilter) {
                    let found = false;
                    for (let key in row) {
                        if (!key.startsWith('_') && row[key]) {
                            const value = String(row[key]).toLowerCase();
                            if (value.includes(mobileGlobalFilter)) {
                                found = true;
                                break;
                            }
                        }
                    }
                    if (!found) return false;
                }

                // Column-specific filters
                for (let column in mobileColumnFilters) {
                    const filterValue = mobileColumnFilters[column];
                    if (filterValue) {
                        if (row[column]) {
                            const cellValue = String(row[column]).toLowerCase();
                            if (!cellValue.includes(filterValue)) {
                                return false;
                            }
                        } else {
                            return false;
                        }
                    }
                }

                // Notes filter
                if (mobileNotesFilter) {
                    const address = row.Address || row.address;
                    const hasNotes = address && notesData[address] && notesData[address].length > 0;
                    if (mobileNotesFilter === 'has_notes' && !hasNotes) return false;
                    if (mobileNotesFilter === 'no_notes' && hasNotes) return false;
                }

                return true;
            });

            // Apply sorting
            if (mobileSortCol) {
                filteredData.sort((a, b) => {
                    if (mobileSortCol === 'Notes') {
                        const aAddress = a.Address || a.address;
                        const bAddress = b.Address || b.address;
                        const aNotesCount = (aAddress && notesData[aAddress]) ? notesData[aAddress].length : 0;
                        const bNotesCount = (bAddress && notesData[bAddress]) ? notesData[bAddress].length : 0;
                        return mobileSortDir === 'asc' ? aNotesCount - bNotesCount : bNotesCount - aNotesCount;
                    }

                    let aVal = a[mobileSortCol] || '';
                    let bVal = b[mobileSortCol] || '';

                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return mobileSortDir === 'asc' ? aNum - bNum : bNum - aNum;
                    }

                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    if (aVal < bVal) return mobileSortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return mobileSortDir === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Render cards
            filteredData.forEach(row => {
                const card = document.createElement('div');
                card.className = 'property-card';
                card.rowData = row;

                // Add click handler for highlight and copy
                card.addEventListener('click', () => highlightCard(card, row));

                // Add all fields and track the last one
                let lastFieldDiv = null;
                for (let key in row) {
                    if (!key.startsWith('_') &&
                        key.toLowerCase() !== 'latitude' &&
                        key.toLowerCase() !== 'longitude' &&
                        key.toLowerCase() !== 'lat' &&
                        key.toLowerCase() !== 'lng' &&
                        key.toLowerCase() !== 'lon' &&
                        key.toLowerCase() !== 'borough' &&
                        row[key]) {

                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'property-card-field';

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'property-card-field-name';
                        nameSpan.textContent = key + ': ';

                        const valueSpan = document.createElement('span');
                        valueSpan.className = 'property-card-field-value';
                        valueSpan.textContent = row[key];

                        fieldDiv.appendChild(nameSpan);
                        fieldDiv.appendChild(valueSpan);
                        card.appendChild(fieldDiv);

                        lastFieldDiv = fieldDiv; // Track the last field
                    }
                }

                // Add notes if available
                const address = row.Address || row.address;
                const notes = getNotesForAddress(address);
                if (notes.length > 0) {
                    const notesSection = document.createElement('div');
                    notesSection.className = 'property-card-notes';

                    const notesTitle = document.createElement('div');
                    notesTitle.className = 'property-card-notes-title';
                    notesTitle.textContent = 'Notes:';
                    notesSection.appendChild(notesTitle);

                    notes.forEach(note => {
                        const noteDiv = document.createElement('div');
                        noteDiv.className = 'property-card-note';

                        const authorDiv = document.createElement('div');
                        authorDiv.className = 'property-card-note-author';
                        authorDiv.textContent = `${note.name} - ${new Date(note.timestamp).toLocaleDateString()}`;

                        const textDiv = document.createElement('div');
                        textDiv.className = 'property-card-note-text';
                        textDiv.textContent = note.note;

                        noteDiv.appendChild(authorDiv);
                        noteDiv.appendChild(textDiv);
                        notesSection.appendChild(noteDiv);
                    });

                    card.appendChild(notesSection);
                }

                // Add compact "+N" button inline with the last field row
                if (lastFieldDiv) {
                    // Wrap existing field content in a span for left alignment
                    const contentWrapper = document.createElement('span');
                    while (lastFieldDiv.firstChild) {
                        contentWrapper.appendChild(lastFieldDiv.firstChild);
                    }

                    // Make the last field a flex container
                    lastFieldDiv.style.display = 'flex';
                    lastFieldDiv.style.justifyContent = 'space-between';
                    lastFieldDiv.style.alignItems = 'center';

                    // Add wrapped content back
                    lastFieldDiv.appendChild(contentWrapper);

                    // Create compact button
                    const addNoteBtn = document.createElement('button');
                    addNoteBtn.textContent = '+N';
                    addNoteBtn.className = 'add-note-btn-compact';
                    addNoteBtn.style.padding = '4px 9px';
                    addNoteBtn.style.fontSize = '11px';
                    addNoteBtn.style.background = 'white';
                    addNoteBtn.style.color = '#111';
                    addNoteBtn.style.border = '1px solid #e63946';
                    addNoteBtn.style.borderRadius = '3px';
                    addNoteBtn.style.cursor = 'pointer';
                    addNoteBtn.style.flexShrink = '0';
                    addNoteBtn.style.marginLeft = '8px';
                    addNoteBtn.style.lineHeight = '1';
                    addNoteBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent card click
                        openAddNoteModal(row);
                    });
                    addNoteBtn.addEventListener('mouseenter', function() {
                        this.style.background = '#e63946';
                        this.style.color = 'white';
                    });
                    addNoteBtn.addEventListener('mouseleave', function() {
                        this.style.background = 'white';
                        this.style.color = '#111';
                    });
                    addNoteBtn.addEventListener('touchstart', function() {
                        this.style.background = '#e63946';
                        this.style.color = 'white';
                    }, { passive: true });
                    addNoteBtn.addEventListener('touchend', function() {
                        setTimeout(() => {
                            this.style.background = 'white';
                            this.style.color = '#111';
                        }, 100);
                    }, { passive: true });

                    lastFieldDiv.appendChild(addNoteBtn);
                }

                cardsContent.appendChild(card);
            });

            // Update result count
            const resultCountElement = document.getElementById('mobileResultCount');
            const hasFilters = mobileGlobalFilter || mobileNotesFilter || Object.values(mobileColumnFilters).some(v => v !== '');
            if (hasFilters) {
                resultCountElement.textContent = `${filteredData.length} of ${allData.length} properties`;
            } else {
                resultCountElement.textContent = `${allData.length} properties`;
            }
        }

        // Highlight card and copy to clipboard
        function highlightCard(card, rowData) {
            // Remove previous selection
            document.querySelectorAll('.property-card').forEach(c => {
                c.classList.remove('selected');
            });

            // Add selection to clicked card
            card.classList.add('selected');

            // Copy to clipboard (reuse same logic as table)
            if (rowData) {
                const clipboardLines = [];

                Object.keys(rowData).forEach(key => {
                    if (!key.startsWith('_') &&
                        key.toLowerCase() !== 'latitude' &&
                        key.toLowerCase() !== 'longitude' &&
                        key.toLowerCase() !== 'lat' &&
                        key.toLowerCase() !== 'lng' &&
                        key.toLowerCase() !== 'lon') {

                        const value = rowData[key];
                        if (value !== null && value !== undefined && value !== '') {
                            clipboardLines.push(`${key}: ${value}`);
                        }
                    }
                });

                const address = rowData.Address || rowData.address;
                const notes = getNotesForAddress(address);
                if (notes.length > 0) {
                    clipboardLines.push('');
                    clipboardLines.push('Notes:');
                    notes.forEach(note => {
                        clipboardLines.push(`  - ${note.name} (${new Date(note.timestamp).toLocaleString()}): ${note.note}`);
                    });
                }

                const clipboardText = clipboardLines.join('\n');

                navigator.clipboard.writeText(clipboardText).then(() => {
                    console.log('Property details copied to clipboard');

                    const notification = document.getElementById('copyNotification');
                    notification.classList.add('show');

                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy to clipboard:', err);
                });
            }
        }

        // ==================== ADD NOTE MODAL FUNCTIONALITY ====================

        let modalSelectedProperty = null; // Property for modal note submission

        // Open the add note modal
        function openAddNoteModal(rowData) {
            modalSelectedProperty = rowData;
            const modal = document.getElementById('addNoteModal');
            const addressDiv = document.getElementById('modalPropertyAddress');
            const messageDiv = document.getElementById('modalNoteFormMessage');

            // Display property address
            const address = rowData.Address || rowData.address || 'Unknown address';
            addressDiv.textContent = `Property: ${address}`;

            // Clear form and messages
            document.getElementById('modalNoteAuthorInput').value = '';
            document.getElementById('modalNoteTextInput').value = '';
            messageDiv.innerHTML = '';

            // Show modal
            modal.classList.remove('hidden');
        }

        // Close the add note modal
        function closeAddNoteModal() {
            const modal = document.getElementById('addNoteModal');
            modal.classList.add('hidden');
            modalSelectedProperty = null;
        }

        // Close modal when clicking X button
        document.getElementById('closeNoteModal').addEventListener('click', closeAddNoteModal);

        // Close modal when clicking outside of it
        document.getElementById('addNoteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddNoteModal();
            }
        });

        // Handle modal note submission
        document.getElementById('modalSubmitNoteBtn').addEventListener('click', async function() {
            const authorInput = document.getElementById('modalNoteAuthorInput');
            const textInput = document.getElementById('modalNoteTextInput');
            const messageDiv = document.getElementById('modalNoteFormMessage');

            const author = authorInput.value.trim();
            const noteText = textInput.value.trim();

            // Clear previous messages
            messageDiv.innerHTML = '';

            // Validate inputs
            if (!author || !noteText) {
                messageDiv.innerHTML = '<div style="color: #e63946; font-size: 12px;">Please enter both your name and a note.</div>';
                return;
            }

            if (!modalSelectedProperty) {
                messageDiv.innerHTML = '<div style="color: #e63946; font-size: 12px;">No property selected.</div>';
                return;
            }

            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                messageDiv.innerHTML = '<div style="color: #e63946; font-size: 12px;">Google Apps Script URL not configured.</div>';
                return;
            }

            const address = modalSelectedProperty.Address || modalSelectedProperty.address;

            // Disable button during submission
            this.disabled = true;
            this.textContent = 'Submitting...';
            this.style.background = '#999';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        name: author,
                        note: noteText
                    })
                });

                // Note: With no-cors mode, we can't read the response
                // But we can assume success and reload notes
                messageDiv.innerHTML = '<div style="color: #28a745; font-size: 12px;">Note submitted successfully!</div>';

                // Clear form
                authorInput.value = '';
                textInput.value = '';

                // Reload notes after a short delay to allow Google Sheets to update
                setTimeout(() => {
                    loadNotes();
                    closeAddNoteModal();
                    // Refresh the current view
                    if (currentView === 'list') {
                        if (window.innerWidth <= 768) {
                            filterAndRenderMobileCards();
                        } else {
                            filterAndRenderTableRows();
                        }
                    }
                }, 1500);

            } catch (error) {
                console.error('Error submitting note:', error);
                messageDiv.innerHTML = '<div style="color: #e63946; font-size: 12px;">Error submitting note. Please try again.</div>';
            } finally {
                this.disabled = false;
                this.textContent = 'Submit Note';
                this.style.background = '#e63946';
            }
        });

        // Mobile filter toggle
        document.getElementById('mobileFiltersToggle').addEventListener('click', function() {
            const content = document.getElementById('mobileFiltersContent');
            const icon = document.getElementById('mobileFiltersIcon');
            content.classList.toggle('show');
            icon.textContent = content.classList.contains('show') ? '▲' : '▼';
        });

        // Mobile global search
        document.getElementById('mobileGlobalSearch').addEventListener('input', debounce(function(e) {
            mobileGlobalFilter = e.target.value.toLowerCase();
            filterAndRenderMobileCards();
        }, 300));

        // Mobile notes filter
        document.getElementById('mobileNotesFilter').addEventListener('change', function(e) {
            mobileNotesFilter = e.target.value;
            filterAndRenderMobileCards();
        });

        // Mobile clear filters
        document.getElementById('mobileClearFilters').addEventListener('click', function() {
            document.getElementById('mobileGlobalSearch').value = '';
            document.getElementById('mobileNotesFilter').value = '';
            mobileGlobalFilter = '';
            mobileNotesFilter = '';
            mobileColumnFilters = {};

            // Clear all column filter inputs
            document.querySelectorAll('#mobileColumnFilters input').forEach(input => {
                input.value = '';
            });

            filterAndRenderMobileCards();
        });

        // Mobile sort column
        document.getElementById('mobileSortColumn').addEventListener('change', function(e) {
            mobileSortCol = e.target.value;
            filterAndRenderMobileCards();
        });

        // Mobile sort direction
        document.getElementById('mobileSortDirection').addEventListener('click', function() {
            mobileSortDir = mobileSortDir === 'asc' ? 'desc' : 'asc';
            this.textContent = mobileSortDir === 'asc' ? '↑ Asc' : '↓ Desc';
            if (mobileSortCol) {
                filterAndRenderMobileCards();
            }
        });

    </script>
</body>
</html>
